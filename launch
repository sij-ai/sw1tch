#!/bin/bash

# Set full PATH for cron execution - ensures all commands are available
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

# File paths for sw1tch and tuwunel integration
BASE_PATH="/home/sij/hand_of_morpheus/sw1tch"        # Base directory for sw1tch package
TOKEN_FILE="$BASE_PATH/data/.registration_token"     # File storing the current registration token
LOG_FILE="$BASE_PATH/logs/token_refresh.log"         # Log file for token refresh and script actions
BACKUP_PATH="/home/sij/tuwunel_backup"               # Directory for tuwunel backups
ENV_FILE="$BASE_PATH/config/tuwunel.env"             # Environment file for tuwunel settings
REPO_PATH="$HOME/workshop/tuwunel"                   # Path to tuwunel source repository
CONFIG_FILE="$BASE_PATH/config/config.yaml"          # sw1tch configuration file
COMPOSE_FILE="docker-compose.yaml"                   # Docker Compose file path

# Static container settings for tuwunel
CONTAINER_NAME="tuwunel"                             # Name of the tuwunel Docker container
CONTAINER_IMAGE="ghcr.io/matrix-construct/tuwunel:v1.1.0-release-all-x86_64-linux-gnu"

# Flags to control script behavior (default to false)
REFRESH_TOKEN=false  # --refresh-token: Generates a new registration token
SUPER_ADMIN=false    # --super-admin: Sets an emergency password for @conduit user
UPDATE=false         # --update: Pulls the latest tuwunel source code
PULL=false           # --pull: Pulls the latest tuwunel Docker image
FORCE_RESTART=false  # --force-restart: Forces a restart of the sw1tch service

# Function to log messages with a timestamp to both file and terminal
log() {
    local message="$(date --iso-8601=seconds) $1"
    echo "$message" >> "$LOG_FILE"
    echo "$message"
}

# Function to refresh the registration token
refresh_token() {
    NEW_TOKEN=$(openssl rand -hex 3)  # Short token for simplicity
    echo -n "$NEW_TOKEN" > "$TOKEN_FILE"
    if [ $? -ne 0 ]; then
        log "ERROR: Failed to write new token to $TOKEN_FILE"
        exit 1
    fi
    log "Generated new registration token: $NEW_TOKEN"
}

# Function to pull the latest tuwunel source
update_repo() {
    log "Pulling latest tuwunel source..."
    cd "$REPO_PATH" || {
        log "ERROR: Failed to cd into $REPO_PATH"
        exit 1
    }
    git pull origin main || {
        log "ERROR: git pull failed"
        exit 1
    }
}

# Function to pull the latest tuwunel Docker image
pull_docker_image() {
    log "Pulling latest tuwunel Docker image..."
    docker compose pull || {
        log "ERROR: Failed to pull Docker image via compose"
        exit 1
    }
    log "Successfully pulled latest image"
}

# Function to restart the tuwunel container using Docker Compose
restart_container() {
    # Handle --super-admin flag by creating/updating environment file
    if [ "$SUPER_ADMIN" = true ]; then
        EMERGENCY_PASSWORD=$(openssl rand -hex 8)  # 16-character hex password
        log "Setting emergency password to: $EMERGENCY_PASSWORD"
        
        # Create or update the environment file for compose with DEBUG logging
        cat > "$ENV_FILE" << EOF
RUST_LOG=tuwunel=debug,tuwunel_service::sending=error,reqwest=error
CONDUWUIT_EMERGENCY_PASSWORD=$EMERGENCY_PASSWORD
EOF
        log "Updated environment file with emergency password and DEBUG logging"
    else
        # Create environment file without emergency password, but WITH DEBUG logging
        cat > "$ENV_FILE" << EOF
RUST_LOG=tuwunel=debug,tuwunel_service::sending=error,reqwest=error
EOF
    fi

    # Update docker-compose.yaml to use env_file if --super-admin is set
    if [ "$SUPER_ADMIN" = true ]; then
        # Create a temporary compose file with env_file
        cat > "docker-compose.override.yaml" << EOF
services:
  tuwunel:
    env_file:
      - $ENV_FILE
EOF
        log "Created compose override for environment variables"
    else
        # Remove override file if it exists
        rm -f "docker-compose.override.yaml"
    fi

    # Check if configuration file exists
    TOML_CONFIG="$BASE_PATH/config/tuwunel.toml"
    if [ ! -f "$TOML_CONFIG" ]; then
        log "ERROR: Configuration file $TOML_CONFIG not found"
        exit 1
    fi
    log "Using configuration from $TOML_CONFIG"

    # Stop and remove existing containers
    log "Stopping existing containers..."
    docker compose down 2>/dev/null || log "No existing containers to stop"

    # Start containers
    log "Starting tuwunel container with Docker Compose..."
    docker compose up -d
    if [ $? -ne 0 ]; then
        log "ERROR: Failed to start containers with docker compose"
        exit 1
    fi

    log "Successfully started container \"$CONTAINER_NAME\" with image \"$CONTAINER_IMAGE\"."
    log " - Configuration loaded from $TOML_CONFIG"
    log " - Using Docker Compose for container management"
    log " - Resource limits defined in compose file"
    
    # Provide login instructions if --super-admin was used
    if [ "$SUPER_ADMIN" = true ]; then
        log "Use the following credentials to log in as the @conduit server user:"
        log "  Username: @conduit:we2.ee"
        log "  Password: $EMERGENCY_PASSWORD"
        log "Once logged in as @conduit:we2.ee, you can invite yourself to the admin room or run admin commands."
    fi
}

# Function to ensure the sw1tch registration service is running via systemd
ensure_registration_service() {
    local service_name="sw1tch"
    
    # Check if systemd service exists
    if ! systemctl list-unit-files | grep -q "^${service_name}.service"; then
        log "ERROR: systemd service ${service_name}.service not found!"
        log "Please create it at: /etc/systemd/system/${service_name}.service"
        log "Then run: sudo systemctl daemon-reload && sudo systemctl enable ${service_name}"
        exit 1
    fi
    
    if [ "$FORCE_RESTART" = true ]; then
        log "Force restarting ${service_name} service via systemd..."
        sudo systemctl restart "$service_name"
        if [ $? -ne 0 ]; then
            log "ERROR: Failed to restart ${service_name} service"
            exit 1
        fi
        log "Successfully restarted ${service_name} service"
    else
        log "Ensuring ${service_name} service is running..."
        sudo systemctl start "$service_name" 2>/dev/null || true
        log "Started or verified ${service_name} service"
    fi
    
    # Wait a moment for service to stabilize
    sleep 2
    
    # Check service status and log it
    log "Service status:"
    sudo systemctl status "$service_name" --no-pager --lines=0 | tee -a "$LOG_FILE"
    
    # Verify the service is actually running
    if ! systemctl is-active --quiet "$service_name"; then
        log "WARNING: Service ${service_name} is not active after start/restart"
        log "Check logs with: sudo journalctl -u ${service_name} -n 50"
    else
        # Get the port from config and verify it's listening
        REG_PORT=$(python3 -c "import yaml, sys; print(yaml.safe_load(open('$CONFIG_FILE')).get('port', 8000))" 2>/dev/null || echo "8000")
        log "Registration service should be listening on port $REG_PORT"
        
        # Verify port is listening (give it a moment)
        sleep 1
        if lsof -ti tcp:"$REG_PORT" > /dev/null 2>&1; then
            log "Confirmed: Service is listening on port $REG_PORT"
        else
            log "WARNING: No process listening on port $REG_PORT yet"
        fi
    fi
}

# Parse command-line flags to determine script actions
while [[ $# -gt 0 ]]; do
    case "$1" in
        --refresh-token) REFRESH_TOKEN=true; shift;;
        --super-admin) SUPER_ADMIN=true; shift;;
        --update) UPDATE=true; shift;;
        --pull) PULL=true; shift;;
        --force-restart) FORCE_RESTART=true; shift;;
        *) log "ERROR: Unknown option: $1"; echo "Usage: $0 [--refresh-token] [--super-admin] [--update] [--pull] [--force-restart]"; exit 1;;
    esac
done

# Execute functions based on flags
if [ "$UPDATE" = true ]; then update_repo; fi
if [ "$PULL" = true ]; then pull_docker_image; fi
if [ "$REFRESH_TOKEN" = true ]; then refresh_token; fi
restart_container  # Always restart container to apply token or image changes
ensure_registration_service  # Always ensure sw1tch is running via systemd

exit 0
