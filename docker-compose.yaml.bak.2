services:
  unbound-resolver:
    image: mvance/unbound:latest
    container_name: unbound-resolver
    restart: unless-stopped
    volumes:
      - ./unbound.conf:/etc/unbound/unbound.conf:ro
    networks:
      matrix_net:
        # Assign a static IP address to our DNS resolver
        ipv4_address: 172.27.0.53
    healthcheck:
      test: ["CMD-SHELL", "unbound-checkconf"]
      interval: 30s
      timeout: 10s
      retries: 3

  tuwunel:
    image: jevolk/tuwunel:latest
    container_name: tuwunel
    restart: unless-stopped
    ports:
      - "8008:8008"
    env_file:
      - ./sw1tch/config/tuwunel.env
    networks:
      - matrix_net
    volumes:
      - db:/var/lib/conduwuit/
      - ./sw1tch/data/.registration_token:/.registration_token:ro
      - /home/sij/tuwunel_backup:/backup
      - ./sw1tch/config/tuwunel.toml:/etc/tuwunel/tuwunel.toml:ro
    command: ["--config", "/etc/tuwunel/tuwunel.toml"]
    dns:
      # Use the static IP of our Unbound container
      - 172.27.0.53
      # Add a public fallback for resilience
      - 1.1.1.1
    depends_on:
      unbound-resolver:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '4.0'
          memory: 16G
        reservations:
          cpus: '2.0'
          memory: 4G

  mautrix-signal:
    image: dock.mau.dev/mautrix/signal:latest
    container_name: mautrix-signal
    restart: unless-stopped
    networks:
      - matrix_net
    volumes:
      - /home/sij/mautrix/signal-bridge/docker:/data:z
    dns:
      # Use the static IP of our Unbound container
      - 172.27.0.53
      - 1.1.1.1
    depends_on:
      - tuwunel
      - unbound-resolver

  diagnostics:
    image: nicolaka/netshoot
    container_name: diagnostics
    restart: unless-stopped
    networks:
      - matrix_net
    command: ["sleep", "infinity"]

volumes:
  db:
    external: true

networks:
  matrix_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.27.0.0/16
